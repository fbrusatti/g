$(document).ready(function() {

  $('input[name="daterange"]').daterangepicker();
    /*********
    DATA-TABLE
    **********/

  // function principal to show
  // ---------------------------
  var oTablelp, bMyProperties;
  bMyProperties = false;
  oTablelp = $('#lastest-changes').dataTable({
    sPaginationType: "full_numbers",
    bJQueryUI: true,
    bProcessing: true,
    bServerSide: true,
    sAjaxSource: $('#lastest-changes').data('source'),
    bAutoWidth: false,
    oLanguage: { sUrl: "/datatables/spanish.txt" },
    aaSorting: [[ 2, "desc" ]],
    aoColumns: [
      { "sWidth": "45%", "bSearchable": false },
      { "sWidth": "10%", "sClass": "center", "bSearchable": true },
      { "sWidth": "10%", "bSearchable": true }
    ],
    fnInitComplete: function(oSettings, json) {
      /* Add a select menu for each TH element in the table footer */
      var column = 2;
      $('button').click( function () {
        start = $('input[name="daterangepicker_start"]').val();
        end = $('input[name="daterangepicker_end"]').val();
        oTablelp.fnFilter(start+" "+end, column);
      });
      $('.ranges ul > li').click( function () {
        start = $('input[name="daterangepicker_start"]').val();
        end = $('input[name="daterangepicker_end"]').val();
        oTablelp.fnFilter(start+" "+end, column);
      });
      $("thead th").each( function ( i ) {
        $('select', this).change( function () {
          oTablelp.fnFilter( $(this).val(),i);
         });
      });
    }

  });

  // row select
  // ----------
  var giRedraw = false
  // Add a click handler to the rows - this could be used as a callback
  $("#lastest-changes tbody").click(function(event) {
    $(oTablelp.fnSettings().aoData).each(function (){
      $(this.nTr).removeClass('row_selected');
    });
    $(event.target.parentNode).addClass('row_selected');
  });
  // Add a click handler for the delete row
  $('#delete').click( function() {
    var anSelected = fnGetSelected( oTablelp );
    oTablelp.fnDeleteRow( anSelected[0] );
  } );

  // handle the datatable with keyboard
  $(document).keydown(function (event) {
    var currentRow = $("#landing-page .row_selected").get(0);
    switch(event.keyCode){
      case 9: // tab
        event.preventDefault();
        $('#lastest-changes_filter input').focus();
        break;
      case 40: //arrow down
        if ($(currentRow).next().length != 0) {
          $(currentRow).next().addClass("row_selected");
          $(currentRow).removeClass("row_selected");
        }
        break;
      case 38: //arrow up
        if ($(currentRow).prev().length != 0) {
          $(currentRow).prev().addClass("row_selected");
          $(currentRow).removeClass("row_selected");
        }
        break;
      case 13: //enter
        var row = $(".row_selected .sorting_1 a");
        if (row.length) {
          row[0].click()
        }
        break;
     }
  });

  // select the first datatable's row when enter is pressed
  $(document).on('keyup', '#lastest-changes_filter input', function(event){
    var nothingSelected = $('#lastest-changes .row_selected').length == 0;
    if (event.which == 13 && nothingSelected){
      $('#lastest-changes tbody tr:first td:first').click()
    }
  });

});// END-$(document)

  /*********
  DATA-TABLE
  **********/

// Get the rows which are currently selected
function fnGetSelected( oTableLocal ){
  var aReturn = new Array();
  var aTrs = oTableLocal.fnGetNodes();
  for ( var i=0 ; i<aTrs.length ; i++ ){
    if ( $(aTrs[i]).hasClass('row_selected') ){
      aReturn.push( aTrs[i] );
    }
  }
  return aReturn;
}
