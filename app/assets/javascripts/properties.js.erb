$(document).ready(function() {

  hiddenInputs();

  // button save of form property
  $("a.property-save").click(function() {
    if (validateTransactions()){
      cleanUpTransactionFields();
      $("#new_property, [id^=edit_property_]").submit();
    } else
      alert("<%= I18n.t('properties.transactions.error') %>");
  });

  $(".gallery").fancybox({
    openEffect  : 'elastic',
    closeEffect : 'elastic',
    prevEffect  : 'elastic',
    nextEffect  : 'elastic'
  });

  // close the photo and set _destroy
  $('form').on('click', '.remove_fields', function(event) {
    $(this).siblings().find("input[type=hidden]").val('1');
    $(this).closest('.photo').hide();
    return event.preventDefault();
  });

  // add new photo
  $('form').on('click', '.add_fields', function(event) {
    var regexp, time;
    time = new Date().getTime();
    regexp = new RegExp($(this).data('id'), 'g');
    $(this).before($(this).data('fields').replace(regexp, time));
    event.preventDefault();
  });

  // token to customer
  $('#property_owner_tokens').tokenInput('/customers.json', {
    crossDomain: false,
    prePopulate: $('#property_owner_tokens').data('pre'),
    theme: "facebook",
    tokenLimit: "1",
    noResultsText: "<%= I18n.t('.token_input.noResultsText') %>",
    hintText: "<%= I18n.t('.token_input.hintText_surname')%>",
    searchingText: "<%= I18n.t('.token_input.searchingText')%>",
    resultsFormatter: function(item){
      return "<li><p style='color: black' >" + item.name
      + " " + item.surname +  " " + item.dni + " </p> </li>" },
    tokenFormatter: function(item) {
      return "<li><p>" + item.name + " " +
      item.surname + " " + item.dni + " </p> </li>" }
  });

  // changes the visibility of transactions inputs
  $("#to_sale, #to_rent").on('click', function(e){
    $(this).parents(".thorizontal").siblings().toggle("show");
  });

});

function validateTransactions(){
  var rent, sale, tinput, sale_ok, rent_ok;
  sale_ok = true; rent_ok = true;
  rent = $('#to_rent');
  sale = $('#to_sale');
  if (sale.prop('checked')){
    tinput = sale.parents(".thorizontal").siblings().children(".tinput");
    tinput.children().each( function(i, e){
      sale_ok =  sale_ok && $(e).val() !=""
    })
  }
  if (rent.prop('checked')){
    tinput = rent.parents(".thorizontal").siblings().children(".tinput");
    tinput.children().each( function(i, e){
      rent_ok =  rent_ok && $(e).val() !=""
    })
  }
  return sale_ok && rent_ok
}

// clean up the input and select fields that aren't checked
function cleanUpTransactionFields() {
 var rent, sale, tinput;
  rent = $('#to_rent');
  sale = $('#to_sale');
  if (!sale.prop('checked')){
    tinput = sale.parents(".thorizontal").siblings().children(".tinput");
    tinput.children().each( function(i, e){
      $(e).val("");
    })
  }
  if (!rent.prop('checked')){
    tinput = rent.parents(".thorizontal").siblings().children(".tinput");
    tinput.children().each( function(i, e){
      $(e).val("");
    })
  }
}

function hiddenInputs () {
  var rent, sale;
  rent = $('#to_rent');
  sale = $('#to_sale');
  if (!rent.prop('checked')){
    rent.parents(".thorizontal").siblings().hide();
  }
  if (!sale.prop('checked')) {
    sale.parents(".thorizontal").siblings().hide();
  }
}
