$(document).ready(function() {

  $("a.customer-save").click( function() {
    $("a.customer-save").attr("disabled", true);
    $("#new_customer, [id^=edit_customer_]").submit();
  });

  $('#customer-dob').datetimepicker({
    maskInput: true,
    pickDate: true,
    pickTime: false,
    pick12HourFormat: false,
    pickSeconds: false,
    startDate: 1910,
    endDate:  Date.today
  });

  var oTableIndex = $('#customers').dataTable({
    sPaginationType: "full_numbers",
    bJQueryUI: true,
    bProcessing: true,
    bServerSide: true,
    "aaSorting": [[ 0, "desc" ]],
    sAjaxSource: $('#customers').data('source'),
    oLanguage: {
      sUrl: "/datatables/spanish.txt"
    },
    "fnInitComplete": function(oSettings, json) {
      /* Add a select menu for each TH element in the table footer */
      var column = 9;
      $('button').click( function () {
        start = $('input[name="daterangepicker_start"]').val();
        end = $('input[name="daterangepicker_end"]').val();
        oTableIndex.fnFilter(start+" "+end, column);
       });

      $('.ranges ul > li').click( function () {
        start = $('input[name="daterangepicker_start"]').val();
        end = $('input[name="daterangepicker_end"]').val();
        oTableIndex.fnFilter(start+" "+end, column);
       });

      $("thead th").each( function ( i ) {
        $('select', this).change( function () {
          oTableIndex.fnFilter( $(this).val(),i);
         });
      });
    }
  });

  // row select
  // ----------
  var giRedraw = false
  // Add a click handler to the rows - this could be used as a callback
  $("#customers tbody").click(function(event) {
    $(oTableIndex.fnSettings().aoData).each(function (){
      $(this.nTr).removeClass('row_selected');
    });
    $(event.target.parentNode).addClass('row_selected');
  });
  // Add a click handler for the delete row
  $('#delete').click( function() {
    var anSelected = fnGetSelected( oTableIndex );
    oTableIndex.fnDeleteRow( anSelected[0] );
  });


  // handle the datatable with keyboard
  $(document).keydown(function (event) {
    var currentRow = $("#customers .row_selected").get(0);
    switch(event.keyCode){

      case 9: // tab
        event.preventDefault();
        $('#customers_filter input').focus();
        break;
      case 40: //arrow down
        if ($(currentRow).next().length != 0) {
          $(currentRow).next().addClass("row_selected");
          $(currentRow).removeClass("row_selected");
        }
        break;
      case 38: //arrow up
        if ($(currentRow).prev().length != 0) {
          $(currentRow).prev().addClass("row_selected");
          $(currentRow).removeClass("row_selected");
        }
        break;
      case 13: //enter
        var row = $(".row_selected .sorting_1 a");
        if (row.length) {
          row[0].click()
        }
        break;
     }
  });

  // select the first datatable's row when enter is pressed
  $(document).on('keyup', '#customers_filter input', function(event){
    var nothingSelected = $('#customers .row_selected').length == 0;
    if (event.which == 13 && nothingSelected){
      $('#customers tbody tr:first td:first').click()
    }
  });

  $('input[name="daterange"]').daterangepicker(
    { format: 'DD/MM/YYYY',
      ranges: {
        "<%= I18n.t('customers.datatables.today') %>":
          [moment(), moment()],
        "<%= I18n.t('customers.datatables.yesterday') %>":
          [moment().subtract('days', 1),
          moment().subtract('days', 1)],
        "<%= I18n.t('customers.datatables.last_7_days') %>":
          [moment().subtract('days', 6), moment()],
        "<%= I18n.t('customers.datatables.last_30_days') %>":
          [moment().subtract('days', 29), moment()],
        "<%= I18n.t('customers.datatables.this_month') %>":
          [moment().startOf('month'), moment().endOf('month')],
        "<%= I18n.t('customers.datatables.last_month') %>":
          [moment().subtract('month', 1).startOf('month'),
          moment().subtract('month', 1).endOf('month')]
      },
      startDate: moment().subtract('days', 29),
      endDate: moment()
    },
    function(start, end) {
      $('#reportrange span').html(start.format + '-' + end);
    }
  );

  $('#show-customer-property').dataTable({
    sPaginationType: "full_numbers",
    bJQueryUI: true,
    oLanguage: {
      sUrl: "/datatables/spanish.txt"
    }
  });

  var oTable = $('#history').dataTable({
    sPaginationType: "full_numbers",
    bJQueryUI: true,
    bProcessing: true,
    bServerSide: true,
    "aaSorting": [[ 2, "asc" ]],
    // "sDom": "Rlfrtip",
    sAjaxSource: $('#history').data('source'),
    oLanguage: {
      sUrl: "/datatables/spanish.txt"
    },
    "fnInitComplete": function(oSettings, json) {
      /* Add a select menu for each TH element in the table footer */
      var column = 2;
      $('button').click( function () {
        start = $('input[name="daterangepicker_start"]').val();
        end = $('input[name="daterangepicker_end"]').val();
        oTable.fnFilter(start+" "+end, column);
       });

      $('.ranges ul > li').click( function () {
        start = $('input[name="daterangepicker_start"]').val();
        end = $('input[name="daterangepicker_end"]').val();
        oTable.fnFilter(start+" "+end, column);
       });

      $("thead#customer-history-head th").each( function ( i ) {
        $('select', this).change( function () {
          oTable.fnFilter( $(this).val(),i);
         });
      });
    }
  });

});
